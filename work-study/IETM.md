## System Backup

### Assumptions:
1. There is **one central server** hosting the application, Docker images, static data, and PostgreSQL.
2. The four other locations are **clients/thin clients** accessing the central server over an intranet.
3. All data changes are committed to the central server.

Our backup focus currentlt shifts entirely to ensuring the resilience of that **single central server**.

---

### Stage 1: Local Server Backup (On the Central Server Location)

This stage aims for **rapid recovery** from minor issues (like a corrupted file or a failed update). You need consistency and speed here.

For the three components:
- **Code/Docker Image:** Since the image is defined by code in Git and built artifacts, the best local backup is ensuring a **clean, accessible artifact repository (like a local Docker Registry)** and a **version-controlled source code repository (Git)** _on that same physical machine or local network segment (NAS)_. If the main application fails, you can quickly pull the last known good image locally.
- **Static Data (Manuals/Docs) & PostgreSQL Data:** The key here is **transactional consistency**. For both the static files and the database, you should use a mechanism that captures a "snapshot in time"

### Stage 2: Complete System Backup (Off-Site/Disaster Recovery)

This stage protects against a total site loss (e.g., hardware failure, power failure, site disaster). This requires durable, geo-redundant storage, which you correctly identified as **off-site object storage**.

---


## PostgreSQL Backup Implementation Plan
| **Component**                      | **Stage 1: Local Server Backup (Fast Recovery)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | **Stage 2: Complete System Backup (Disaster Recovery)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ---------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **PostgreSQL** (via Docker Volume) | **Tool:** **pgBackRest** (Recommended) or **WAL-G**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | **Tool:** **pgBackRest** (or **WAL-G**) + Secure **Off-Site Storage (e.g., dedicated NAS/Tape or cloud-compatible internal S3)**                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Implementation Details**         | 1. **Configure Continuous Archiving:** Enable PostgreSQL's `archive_mode` and set the `archive_command` to push the **Write-Ahead Logs (WALs)** to a local, dedicated backup volume (e.g., a high-speed local NAS/SAN). <br><br>2. **Run Daily Base Backups:** Schedule a daily, automated full base backup using `pgBackRest` to the same local backup volume. <br><br>3. **Benefit:** This setup allows you to restore the database to _any point in time_ (PITR) between the last base backup and the latest archived WAL file, providing sub-minute recovery granularity. | 1. **Replicate the Repository:** Use `pgBackRest` to configure a **second, remote repository** for its backups and WAL archives. <br><br>2. **Secure Transfer:** Utilize the internal network's most secure transfer mechanism (e.g., **SSH/SFTP** for simple setups, or the native cloud-agnostic protocols of the tool) to send the entire `pgBackRest` repository to the off-site (geo-redundant) storage location. <br><br>3. **Encryption:** Ensure all data transfer and storage is **encrypted** using AES-256 (mandatory for defense data). |

---

## 2. Static Data (Manuals/Docs) and Docker Volumes

This includes the persistent volume storing your documents, manuals, and any configuration files. This is where a modern, deduplicating backup tool is perfect.

| **Component**                    | **Stage 1: Local Server Backup (Fast Recovery)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | **Stage 2: Complete System Backup (Disaster Recovery)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Static Data & Config Volumes** | **Tool:** **Restic** or **`Kopia`** (Containerized)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | **Tool:** **Restic** or **Kopia** + Secure **Off-Site Storage (e.g., dedicated NAS/Tape or cloud-compatible internal S3)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Implementation Details**       | 1. **Run as a Sidecar Container:** Implement Restic/Kopia as a separate Docker container in your `docker-compose.yml`. <br><br>2. **Mount Volumes:** This sidecar container mounts the Docker volumes (Static Data, PostgreSQL's local backup volume, etc.) it needs to back up. <br><br>3. **Local Repository:** The tool creates a **deduplicated, encrypted repository** on a dedicated, local, high-speed storage device (e.g., a local disk array or local NAS). <br><br>4. **Scheduling:** Schedule this container to run **hourly incremental snapshots**. The deduplication makes the incremental snapshots tiny and fast. | 1. **Cross-Repository Sync:** Configure the local Restic/Kopia repository to **replicate/copy its snapshots** to the remote, off-site repository. <br><br>2. **Secure Transfer:** Use the tool's native support for secure protocols (like **SFTP, or S3-compatible endpoints** on a dedicated off-site server) to push the encrypted deduplicated chunks to the disaster recovery location. <br><br>3. **Benefit:** **Massive storage savings** due to deduplication (static manuals rarely change completely) and the ability to restore any version from the highly durable off-site location. |

## Code Backup (optional)
- Best form of backup for code (Docker Image) is through source control through a self-hosted air gaped Docker Image repository.
- *However* it's much easier to keep a direct copy of the docker-image of the server. If updates are there they can be delivered directly as docker-image.tar file

| **Component**         | **Strategy**                                                                                                                                     | **Technical Implementation**                                         |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------- |
| **Code Image Backup** | Back up the final, built Docker image itself. This image is a snapshot of the application code, its dependencies, and the operating environment. | **`docker save`** or a dedicated **Image Registry** (`docker push`). |
### Stage 1: Local Server Backup (Image Resilience)

For fast recovery from a corrupted running container or a bad update on the central server, you need a local cache of known-good images.

1. **Local Image Cache:** The central server's Docker daemon naturally stores all images it has pulled or built locally. If a running container fails, you can instantly start a new container from the locally available, uncorrupted image.
2. **Local Self-Hosted Registry/Cache (more robust):** The best method is to run a lightweight, local **Docker Registry** (e.g., a simple deployment of the open-source **Docker Registry** or an integrated solution like **Harbor**) on the central server or an adjacent local storage appliance.
    - **Benefit:** This registry holds tagged versions (e.g., `ietm:v1.0.0`, `ietm:v1.0.1`). If the currently running image is corrupted, you can immediately pull a previous working version from this **local registry** for a quick rollback without relying on external access.

### Stage 2: Complete System Backup (Disaster Recovery)

For a complete server loss, you need the images stored safely off-site.
**Option A: Export and Store:** Periodically use the **`docker save`** command to export the critical, verified production images into a compressed `.tar` file. This file is then backed up using **Restic/Kopia** to the off-site location.
**Option B: Backup the Registry Volume:** If using a self-hosted registry (e.g., Harbor), the persistent volume storing the image layers and metadata is backed up using your file backup tool (**Restic/Kopia**) and sent to the off-site location.


## Justifications for Tool Choice

| **Tool**                                          | **Why it's Best for This Architecture**                                                                                                                                                                                                                                                                 | **Key Feature for HLD**                    |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------ |
| **pgBackRest** (or **WAL-G**)                     | **PostgreSQL-native.** Guarantees a transactionally consistent backup and supports **PITR** (Point-in-Time Recovery), allowing restoration to the exact moment before a failure or error.                                                                                                               | **PITR and Block-Level Backups**           |
| **Restic** / **Kopia**                            | **Deduplication:** Only stores chunks that have changed, drastically reducing storage size for the large static manuals. **Encryption:** All data is encrypted _before_ it leaves the server. **Docker-native:** Can be easily run as a container to mount and back up other Docker volumes.            | **Content-Defined Deduplication**          |
| **Code Image Backup** or **Self-Hosted Registry** | **Rollbacks** is Trivial. Restoring working image is simply running a cmd to pull the working image tag and redeploying the container.<br>**Immutability** cause docker images are read-only snapshots<br>**Storage Efficiency** (When using image registry) automatically handles layer deduplications | **Air-Gapped Image/Artifact Availability** |
